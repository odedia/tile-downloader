name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          # macOS builds
          - name: macOS-Intel
            os: macos-latest
            platform: darwin/amd64
            output_name: tile-downloader-macos-intel
            artifact_path: build/bin/tile-downloader.app

          - name: macOS-ARM
            os: macos-latest
            platform: darwin/arm64
            output_name: tile-downloader-macos-arm64
            artifact_path: build/bin/tile-downloader.app

          # Windows build
          - name: Windows-x64
            os: windows-latest
            platform: windows/amd64
            output_name: tile-downloader-windows-x64
            artifact_path: build/bin/tile-downloader.exe

          # Linux builds
          - name: Linux-x64
            os: ubuntu-latest
            platform: linux/amd64
            output_name: tile-downloader-linux-x64
            artifact_path: build/bin/tile-downloader
            webkit_version: "4.1"

          - name: Linux-x64-RHEL9
            os: ubuntu-latest
            platform: linux/amd64
            output_name: tile-downloader-linux-x64-rhel9
            artifact_path: build/bin/tile-downloader
            webkit_version: "4.0"

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails (Linux)
        if: runner.os == 'Linux'
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Wails (macOS)
        if: runner.os == 'macOS'
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Wails (Windows)
        if: runner.os == 'Windows'
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          if [ "${{ matrix.webkit_version }}" == "4.0" ]; then
            sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev
          else
            sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
          fi

      - name: Download OM CLI binaries
        shell: bash
        run: |
          chmod +x download-om-binaries.sh
          ./download-om-binaries.sh

      - name: Build application
        shell: bash
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          if [ "${{ runner.os }}" == "Linux" ]; then
            if [ "${{ matrix.webkit_version }}" == "4.0" ]; then
              wails build -platform ${{ matrix.platform }} -clean
            else
              wails build -platform ${{ matrix.platform }} -clean -tags webkit2_41
            fi
          else
            wails build -platform ${{ matrix.platform }} -clean
          fi

      - name: Package macOS App
        if: runner.os == 'macOS'
        run: |
          cd build/bin
          zip -r ${{ matrix.output_name }}.zip tile-downloader.app
          mv ${{ matrix.output_name }}.zip ../../

      - name: Package Windows App
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd build/bin
          7z a ../../${{ matrix.output_name }}.zip tile-downloader.exe

      - name: Package Linux App
        if: runner.os == 'Linux'
        run: |
          cd build/bin
          tar -czf ../../${{ matrix.output_name }}.tar.gz tile-downloader

      - name: Upload artifact (macOS/Windows)
        if: runner.os == 'macOS' || runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: ${{ matrix.output_name }}.zip
          retention-days: 5

      - name: Upload artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: ${{ matrix.output_name }}.tar.gz
          retention-days: 5

  release:
    needs: build
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            ## Tile Downloader ${{ steps.version.outputs.VERSION }}

            ### Downloads

            Choose the appropriate binary for your platform:

            - **macOS Intel (x64)**: `tile-downloader-macos-intel.zip`
            - **macOS Apple Silicon (ARM64)**: `tile-downloader-macos-arm64.zip`
            - **Windows x64**: `tile-downloader-windows-x64.zip`
            - **Linux x64** (Ubuntu/Debian/Fedora): `tile-downloader-linux-x64.tar.gz`
            - **Linux x64 RHEL9** (RHEL 9/CentOS 9/Rocky 9): `tile-downloader-linux-x64-rhel9.tar.gz`

            ### Installation

            1. Download the appropriate file for your platform
            2. Extract the archive
            3. Run the application (no additional dependencies required!)

            ### What's Included

            - âœ… Fully portable single binary
            - âœ… Embedded OM CLI (no separate installation needed)
            - âœ… All dependencies bundled

            ### Requirements

            - Broadcom Support Portal API Token

            ### Notes

            - **macOS**: On first run, you may need to right-click and select "Open" to bypass Gatekeeper
            - **Linux**: Make the binary executable: `chmod +x tile-downloader`
            - **Linux**: Requires WebKit2GTK installed:
              - Ubuntu/Debian/Fedora: `sudo apt install libwebkit2gtk-4.1-0` or `sudo dnf install webkit2gtk4.1`
              - RHEL 9/CentOS 9/Rocky 9: Use the RHEL9 build, requires `webkit2gtk3` (`sudo dnf install webkit2gtk3`)

            ---

            ðŸ¤– Built with [Wails](https://wails.io/) and [Go](https://golang.org/)
          files: |
            artifacts/tile-downloader-macos-intel/tile-downloader-macos-intel.zip
            artifacts/tile-downloader-macos-arm64/tile-downloader-macos-arm64.zip
            artifacts/tile-downloader-windows-x64/tile-downloader-windows-x64.zip
            artifacts/tile-downloader-linux-x64/tile-downloader-linux-x64.tar.gz
            artifacts/tile-downloader-linux-x64-rhel9/tile-downloader-linux-x64-rhel9.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
